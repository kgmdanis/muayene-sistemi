<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Muayene Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        #result { margin-top: 20px; padding: 10px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>Muayene Modülü Test</h1>
    
    <div>
        <button onclick="testLogin()">1. Giriş Yap</button>
        <button onclick="getTeklifler()">2. Teklifleri Listele</button>
        <button onclick="createTestMuayene()">3. İlk Onaylanan Tekliften Muayene Oluştur</button>
    </div>
    
    <div id="result"></div>
    
    <script>
        let authToken = '';
        const API_BASE = window.location.origin + '/api';
        
        function log(message, isError = false) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML += `<div class="${isError ? 'error' : 'success'}">${new Date().toLocaleTimeString()} - ${message}</div>`;
        }
        
        async function testLogin() {
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                const data = await response.json();
                if (data.token) {
                    authToken = data.token;
                    log('Giriş başarılı! Token alındı.');
                } else {
                    log('Giriş başarısız!', true);
                }
            } catch (error) {
                log('Hata: ' + error.message, true);
            }
        }
        
        async function getTeklifler() {
            if (!authToken) {
                log('Önce giriş yapın!', true);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/teklifler`, {
                    headers: { 'Authorization': authToken }
                });
                const teklifler = await response.json();
                const onaylanan = teklifler.filter(t => t.durum === 'Onaylandı');
                log(`Toplam ${teklifler.length} teklif var. ${onaylanan.length} tanesi onaylanmış.`);
                
                if (onaylanan.length > 0) {
                    log('Onaylanan teklifler:');
                    onaylanan.forEach(t => {
                        log(`- ${t.teklifNo} (ID: ${t.id}) - Muayene ID: ${t.muayeneId || 'YOK'}`);
                    });
                }
            } catch (error) {
                log('Hata: ' + error.message, true);
            }
        }
        
        async function createTestMuayene() {
            if (!authToken) {
                log('Önce giriş yapın!', true);
                return;
            }
            
            try {
                // Önce teklifleri al
                const teklifResponse = await fetch(`${API_BASE}/teklifler`, {
                    headers: { 'Authorization': authToken }
                });
                const teklifler = await teklifResponse.json();
                const onaylanan = teklifler.find(t => t.durum === 'Onaylandı' && !t.muayeneId);
                
                if (!onaylanan) {
                    log('Muayene oluşturulabilecek onaylanmış teklif yok!', true);
                    return;
                }
                
                log(`${onaylanan.teklifNo} numaralı tekliften muayene oluşturuluyor...`);
                
                // Muayene oluştur
                const response = await fetch(`${API_BASE}/muayeneler`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': authToken 
                    },
                    body: JSON.stringify({ teklifId: onaylanan.id })
                });
                
                if (response.ok) {
                    const muayene = await response.json();
                    log(`Muayene başarıyla oluşturuldu! ID: ${muayene.id}`);
                } else {
                    const error = await response.json();
                    log(`Muayene oluşturulamadı: ${error.error}`, true);
                }
            } catch (error) {
                log('Hata: ' + error.message, true);
            }
        }
    </script>
</body>
</html>