<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teklif Olu≈ütur - √ñNDER MUAYENE</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header { background: #1a5f7a; color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; }
        .btn-light { background: white; color: #1a5f7a; }
        .btn-success { background: #28a745; color: white; }
        .btn-primary { background: #1a5f7a; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn:hover { opacity: 0.9; }
        
        .content { background: white; padding: 20px; }
        
        /* Firma Bilgileri Kutusu - Excel formatƒ± */
        .firma-box { border: 2px solid #000; margin-bottom: 20px; }
        .firma-header { background: #d9e2f3; padding: 8px 15px; font-weight: bold; border-bottom: 1px solid #000; }
        .firma-grid { display: grid; grid-template-columns: 1fr 1fr; }
        .firma-row { display: grid; grid-template-columns: 150px 1fr; border-bottom: 1px solid #ccc; }
        .firma-row:last-child { border-bottom: none; }
        .firma-label { background: #f5f5f5; padding: 8px 10px; font-weight: 600; border-right: 1px solid #ccc; }
        .firma-value { padding: 8px 10px; }
        .firma-value input, .firma-value select { width: 100%; border: none; padding: 5px; font-size: 14px; }
        .firma-value input:focus, .firma-value select:focus { outline: 2px solid #1a5f7a; }
        
        /* Hizmet Tablosu - Excel formatƒ± */
        .kategori-box { border: 2px solid #000; margin-bottom: 15px; }
        .kategori-header { background: #1a5f7a; color: white; padding: 10px 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .kategori-header span { cursor: pointer; }
        
        .hizmet-table { width: 100%; border-collapse: collapse; }
        .hizmet-table th { background: #e7e6e6; padding: 8px; text-align: left; border: 1px solid #000; font-size: 12px; }
        .hizmet-table td { padding: 6px 8px; border: 1px solid #ccc; font-size: 12px; }
        .hizmet-table tr:hover { background: #f5f5f5; }
        
        .col-param { width: 25%; }
        .col-metod { width: 35%; font-size: 11px; color: #666; }
        .col-miktar { width: 8%; text-align: center; }
        .col-birim { width: 8%; text-align: center; }
        .col-fiyat { width: 10%; text-align: right; }
        .col-toplam { width: 10%; text-align: right; font-weight: bold; }
        .col-aksiyon { width: 4%; text-align: center; }
        
        .miktar-input { width: 50px; text-align: center; padding: 4px; border: 1px solid #ccc; border-radius: 3px; }
        .ekle-btn { background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 14px; }
        .sil-btn { background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; }
        
        /* Se√ßilen Hizmetler */
        .secilen-box { border: 2px solid #28a745; margin-top: 20px; }
        .secilen-header { background: #28a745; color: white; padding: 10px 15px; font-weight: bold; }
        
        /* Toplam Kutusu */
        .toplam-box { border: 2px solid #000; margin-top: 20px; max-width: 400px; margin-left: auto; }
        .toplam-row { display: grid; grid-template-columns: 1fr 150px; border-bottom: 1px solid #ccc; }
        .toplam-row:last-child { border-bottom: none; }
        .toplam-label { padding: 10px 15px; font-weight: 600; background: #f5f5f5; }
        .toplam-value { padding: 10px 15px; text-align: right; font-weight: bold; }
        .toplam-row.genel { background: #1a5f7a; color: white; }
        .toplam-row.genel .toplam-label, .toplam-row.genel .toplam-value { background: #1a5f7a; font-size: 16px; }
        
        /* Footer Butonlarƒ± */
        .footer { background: #f5f5f5; padding: 20px; border-radius: 0 0 8px 8px; display: flex; justify-content: space-between; align-items: center; }
        .footer-actions { display: flex; gap: 10px; }
        
        /* Toast */
        .toast { position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 4px; color: white; z-index: 9999; animation: slideIn 0.3s; }
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }
        .toast.warning { background: #ffc107; color: #333; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .empty-msg { padding: 30px; text-align: center; color: #666; }
        
        /* Arama */
        .search-box { padding: 10px; background: #f5f5f5; border-bottom: 1px solid #ccc; }
        .search-box input { width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PERƒ∞YODƒ∞K KONTROL VE ƒ∞≈û Hƒ∞JYENƒ∞ √ñL√á√úM Fƒ∞YAT TEKLƒ∞Fƒ∞</h1>
            <button class="btn btn-light" onclick="window.location.href='/index.html'">‚Üê Ana Sayfa</button>
        </div>
        
        <div class="content">
            <!-- Firma Bilgileri -->
            <div class="firma-box">
                <div class="firma-header">Fƒ∞RMA Bƒ∞LGƒ∞LERƒ∞</div>
                <div class="firma-grid">
                    <div>
                        <div class="firma-row">
                            <div class="firma-label">TEKLƒ∞F TARƒ∞Hƒ∞</div>
                            <div class="firma-value"><input type="date" id="teklifTarihi"></div>
                        </div>
                        <div class="firma-row">
                            <div class="firma-label">TEKLƒ∞F NO</div>
                            <div class="firma-value"><input type="text" id="teklifNo" value="Otomatik" readonly style="background:#eee;"></div>
                        </div>
                        <div class="firma-row">
                            <div class="firma-label">Fƒ∞RMA ADI</div>
                            <div class="firma-value">
                                <select id="musteriSelect" onchange="musteriSecildi()">
                                    <option value="">-- M√º≈üteri Se√ßin --</option>
                                </select>
                            </div>
                        </div>
                        <div class="firma-row">
                            <div class="firma-label">Fƒ∞RMA ADRESƒ∞</div>
                            <div class="firma-value"><span id="musteriAdres">-</span></div>
                        </div>
                    </div>
                    <div>
                        <div class="firma-row">
                            <div class="firma-label">Fƒ∞RMA YETKƒ∞Lƒ∞Sƒ∞</div>
                            <div class="firma-value"><span id="musteriYetkili">-</span></div>
                        </div>
                        <div class="firma-row">
                            <div class="firma-label">TEL/FAX</div>
                            <div class="firma-value"><span id="musteriTel">-</span></div>
                        </div>
                        <div class="firma-row">
                            <div class="firma-label">E-Mail</div>
                            <div class="firma-value"><span id="musteriEmail">-</span></div>
                        </div>
                        <div class="firma-row">
                            <div class="firma-label">KDV ORANI</div>
                            <div class="firma-value">
                                <select id="kdvOrani" onchange="hesaplaToplamlar()">
                                    <option value="0">%0</option>
                                    <option value="10">%10</option>
                                    <option value="20" selected>%20</option>
                                </select>
                            </div>
                        </div>
                        <div class="firma-row">
                            <div class="firma-label">ONAY DURUMU</div>
                            <div class="firma-value" style="display: flex; align-items: center; gap: 25px;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <input type="checkbox" id="onayTelefon" style="width: 18px; height: 18px; cursor: pointer;">
                                    <label for="onayTelefon" style="cursor: pointer; font-size: 13px;">Telefon ile onay</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <input type="checkbox" id="sahadaOnay" style="width: 18px; height: 18px; cursor: pointer;">
                                    <label for="sahadaOnay" style="cursor: pointer; font-size: 13px;">Sahada onay</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Arama -->
            <div class="search-box">
                <input type="text" id="aramaInput" placeholder="Hizmet ara... (√∂rn: topraklama, vin√ß, yangƒ±n)" oninput="hizmetAra()">
            </div>
            
            <!-- Hizmet Kategorileri -->
            <div id="kategorilerContainer"></div>
            
            <!-- Se√ßilen Hizmetler -->
            <div class="secilen-box" id="secilenBox" style="display:none;">
                <div class="secilen-header">SE√áƒ∞LEN Hƒ∞ZMETLER</div>
                <table class="hizmet-table">
                    <thead>
                        <tr>
                            <th class="col-param">√ñl√ß√ºm Parametresi</th>
                            <th class="col-metod">Metod/Kapsam/A√ßƒ±klama</th>
                            <th class="col-miktar">Miktar</th>
                            <th class="col-birim">Birim</th>
                            <th class="col-fiyat">Birim Fiyat</th>
                            <th class="col-toplam">Fiyat</th>
                            <th class="col-aksiyon"></th>
                        </tr>
                    </thead>
                    <tbody id="secilenTbody"></tbody>
                </table>
            </div>
            
            <!-- Toplam -->
            <div class="toplam-box" id="toplamBox" style="display:none;">
                <div class="toplam-row">
                    <div class="toplam-label">ARA TOPLAM</div>
                    <div class="toplam-value" id="araToplam">0,00 ‚Ç∫</div>
                </div>
                <div class="toplam-row">
                    <div class="toplam-label">KDV (<span id="kdvOranText">20</span>%)</div>
                    <div class="toplam-value" id="kdvTutar">0,00 ‚Ç∫</div>
                </div>
                <div class="toplam-row genel">
                    <div class="toplam-label">GENEL TOPLAM</div>
                    <div class="toplam-value" id="genelToplam">0,00 ‚Ç∫</div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <div>
                <strong>Konu:</strong> Periyodik Kontrol ve ƒ∞≈ü Hijyeni √ñl√ß√ºm Fiyat Teklifi
            </div>
            <div class="footer-actions">
                <button class="btn btn-danger" onclick="sepetiTemizle()">üóëÔ∏è Temizle</button>
                <button class="btn btn-success" onclick="teklifKaydet()">üíæ Teklifi Kaydet</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let musteriler = [];
        let kategoriler = [];
        let sepet = [];
        let editingTeklifId = null; // D√ºzenleme modu i√ßin

        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            // Bug√ºn√ºn tarihini ayarla
            document.getElementById('teklifTarihi').value = new Date().toISOString().split('T')[0];

            await Promise.all([loadMusteriler(), loadKategoriler()]);

            // URL'den id parametresini kontrol et (d√ºzenleme modu)
            const urlParams = new URLSearchParams(window.location.search);
            const teklifId = urlParams.get('id');
            if (teklifId) {
                await loadTeklifForEdit(teklifId);
            }
        });

        // D√ºzenleme i√ßin teklifi y√ºkle
        async function loadTeklifForEdit(id) {
            try {
                const res = await fetch(API_BASE + '/api/teklifler/' + id, { headers: getHeaders() });
                if (!res.ok) {
                    showToast('Teklif bulunamadƒ±', 'error');
                    return;
                }

                const teklif = await res.json();
                editingTeklifId = teklif.id;

                // Ba≈ülƒ±ƒüƒ± g√ºncelle
                document.querySelector('.header h1').textContent = 'TEKLƒ∞F D√úZENLE: ' + teklif.teklifNo;

                // Teklif No'yu g√∂ster
                document.getElementById('teklifNo').value = teklif.teklifNo;

                // Tarihi ayarla
                if (teklif.teklifTarihi) {
                    document.getElementById('teklifTarihi').value = teklif.teklifTarihi.split('T')[0];
                }

                // M√º≈üteriyi se√ß
                document.getElementById('musteriSelect').value = teklif.customerId;
                musteriSecildi();

                // KDV oranƒ±nƒ± ayarla
                document.getElementById('kdvOrani').value = teklif.kdvOrani || 20;

                // Onay durumlarƒ±nƒ± ayarla
                document.getElementById('onayTelefon').checked = teklif.onayTelefon || false;
                document.getElementById('sahadaOnay').checked = teklif.sahadaOnay || false;

                // Detaylarƒ± sepete ekle
                if (teklif.detaylar && teklif.detaylar.length > 0) {
                    teklif.detaylar.forEach(detay => {
                        sepet.push({
                            hizmetId: detay.hizmetId,
                            ad: detay.hizmet?.ad || 'Bilinmeyen Hizmet',
                            metodKapsam: detay.hizmet?.metodKapsam || detay.hizmet?.standartYonetmelik || '',
                            birim: detay.hizmet?.birim || 'Adet',
                            birimFiyat: parseFloat(detay.birimFiyat) || 0,
                            miktar: detay.miktar || 1
                        });
                    });
                    renderSepet();
                }

                // Kaydet butonunu g√ºncelle
                document.querySelector('.btn-success').innerHTML = 'üíæ Teklifi G√ºncelle';

                showToast('Teklif y√ºklendi: ' + teklif.teklifNo, 'success');
            } catch (e) {
                console.error('Teklif y√ºkleme hatasƒ±:', e);
                showToast('Teklif y√ºklenirken hata olu≈ütu', 'error');
            }
        }
        
        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            };
        }
        
        async function loadMusteriler() {
            try {
                const res = await fetch(API_BASE + '/api/customers', { headers: getHeaders() });
                musteriler = await res.json();
                const select = document.getElementById('musteriSelect');
                musteriler.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.textContent = m.unvan;
                    select.appendChild(opt);
                });
            } catch (e) { console.error('M√º≈üteri y√ºkleme hatasƒ±:', e); }
        }
        
        function musteriSecildi() {
            const id = document.getElementById('musteriSelect').value;
            const m = musteriler.find(x => x.id == id);
            if (m) {
                document.getElementById('musteriAdres').textContent = m.adres || '-';
                document.getElementById('musteriYetkili').textContent = m.yetkili || '-';
                document.getElementById('musteriTel').textContent = m.telefon || '-';
                document.getElementById('musteriEmail').textContent = m.email || '-';
            } else {
                document.getElementById('musteriAdres').textContent = '-';
                document.getElementById('musteriYetkili').textContent = '-';
                document.getElementById('musteriTel').textContent = '-';
                document.getElementById('musteriEmail').textContent = '-';
            }
        }
        
        async function loadKategoriler() {
            try {
                const res = await fetch(API_BASE + '/api/kategoriler', { headers: getHeaders() });
                kategoriler = await res.json();
                renderKategoriler();
            } catch (e) { console.error('Kategori y√ºkleme hatasƒ±:', e); }
        }
        
        function renderKategoriler(filter = '') {
            const container = document.getElementById('kategorilerContainer');
            container.innerHTML = '';
            
            kategoriler.forEach(kat => {
                const hizmetler = kat.hizmetler.filter(h => 
                    !filter || 
                    h.ad.toLowerCase().includes(filter.toLowerCase()) ||
                    (h.aciklama && h.aciklama.toLowerCase().includes(filter.toLowerCase()))
                );
                
                if (hizmetler.length === 0 && filter) return;
                
                const div = document.createElement('div');
                div.className = 'kategori-box';
                div.innerHTML = `
                    <div class="kategori-header">
                        <span onclick="toggleKategori(this)">${kat.ad}</span>
                        <span onclick="toggleKategori(this)" style="font-size:12px;">‚ñº</span>
                    </div>
                    <div class="kategori-body">
                        <table class="hizmet-table">
                            <thead>
                                <tr>
                                    <th class="col-param">√ñl√ß√ºm Parametresi</th>
                                    <th class="col-metod">Metod/Kapsam/A√ßƒ±klama</th>
                                    <th class="col-miktar">Miktar</th>
                                    <th class="col-birim">Birim</th>
                                    <th class="col-fiyat">Birim Fiyat</th>
                                    <th class="col-toplam">Fiyat</th>
                                    <th class="col-aksiyon"></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${hizmetler.map(h => `
                                    <tr>
                                        <td>${h.ad}</td>
                                        <td class="col-metod">${h.metodKapsam || h.standartYonetmelik || ''}</td>
                                        <td class="col-miktar"><input type="number" class="miktar-input" id="mik-${h.id}" value="1" min="1"></td>
                                        <td class="col-birim">${h.birim}</td>
                                        <td class="col-fiyat"><input type="number" class="miktar-input" id="fiyat-${h.id}" value="${parseFloat(h.birimFiyat) || 0}" min="0" step="0.01" style="width:70px;text-align:right;"></td>
                                        <td class="col-toplam" id="sat-${h.id}">${formatPara(parseFloat(h.birimFiyat) || 0)}</td>
                                        <td class="col-aksiyon"><button class="ekle-btn" onclick="sepeteEkle(${h.id})">+</button></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                container.appendChild(div);
                
                // Miktar veya fiyat deƒüi≈ütiƒüinde satƒ±r toplamƒ±nƒ± g√ºncelle
                hizmetler.forEach(h => {
                    const mikInput = document.getElementById('mik-' + h.id);
                    const fiyatInput = document.getElementById('fiyat-' + h.id);

                    function updateSatirToplam() {
                        const mik = parseInt(mikInput?.value) || 1;
                        const fiyat = parseFloat(fiyatInput?.value) || 0;
                        document.getElementById('sat-' + h.id).textContent = formatPara(mik * fiyat);
                    }

                    if (mikInput) mikInput.addEventListener('input', updateSatirToplam);
                    if (fiyatInput) fiyatInput.addEventListener('input', updateSatirToplam);
                });
            });
        }
        
        function toggleKategori(el) {
            const body = el.closest('.kategori-box').querySelector('.kategori-body');
            body.style.display = body.style.display === 'none' ? 'block' : 'none';
        }
        
        function hizmetAra() {
            const filter = document.getElementById('aramaInput').value;
            renderKategoriler(filter);
        }
        
        function sepeteEkle(hizmetId) {
            let hizmet = null;
            for (const kat of kategoriler) {
                hizmet = kat.hizmetler.find(h => h.id === hizmetId);
                if (hizmet) break;
            }
            if (!hizmet) return;

            const miktar = parseInt(document.getElementById('mik-' + hizmetId)?.value) || 1;
            const birimFiyat = parseFloat(document.getElementById('fiyat-' + hizmetId)?.value) || parseFloat(hizmet.birimFiyat) || 0;

            if (birimFiyat <= 0) {
                showToast('L√ºtfen birim fiyat girin', 'warning');
                return;
            }

            const existing = sepet.find(s => s.hizmetId === hizmetId);
            if (existing) {
                existing.miktar += miktar;
                existing.birimFiyat = birimFiyat; // Fiyatƒ± g√ºncelle
            } else {
                sepet.push({
                    hizmetId: hizmet.id,
                    ad: hizmet.ad,
                    metodKapsam: hizmet.metodKapsam || hizmet.standartYonetmelik || '',
                    birim: hizmet.birim,
                    birimFiyat: birimFiyat,
                    miktar: miktar
                });
            }

            renderSepet();
            showToast('Eklendi: ' + hizmet.ad, 'success');
        }
        
        function sepettenSil(index) {
            sepet.splice(index, 1);
            renderSepet();
        }
        
        function miktarDegistir(index, yeniMiktar) {
            if (yeniMiktar < 1) yeniMiktar = 1;
            sepet[index].miktar = yeniMiktar;
            renderSepet();
        }

        function fiyatDegistir(index, yeniFiyat) {
            if (yeniFiyat < 0) yeniFiyat = 0;
            sepet[index].birimFiyat = yeniFiyat;
            renderSepet();
        }
        
        function renderSepet() {
            const box = document.getElementById('secilenBox');
            const tbody = document.getElementById('secilenTbody');
            const toplamBox = document.getElementById('toplamBox');
            
            if (sepet.length === 0) {
                box.style.display = 'none';
                toplamBox.style.display = 'none';
                return;
            }
            
            box.style.display = 'block';
            toplamBox.style.display = 'block';
            
            tbody.innerHTML = sepet.map((item, i) => {
                const toplam = item.miktar * item.birimFiyat;
                return `
                    <tr>
                        <td>${item.ad}</td>
                        <td class="col-metod">${item.metodKapsam || ''}</td>
                        <td class="col-miktar">
                            <input type="number" class="miktar-input" value="${item.miktar}" min="1"
                                   onchange="miktarDegistir(${i}, parseInt(this.value))">
                        </td>
                        <td class="col-birim">${item.birim}</td>
                        <td class="col-fiyat">
                            <input type="number" class="miktar-input" value="${item.birimFiyat}" min="0" step="0.01"
                                   style="width:70px;text-align:right;"
                                   onchange="fiyatDegistir(${i}, parseFloat(this.value))">
                        </td>
                        <td class="col-toplam">${formatPara(toplam)}</td>
                        <td class="col-aksiyon"><button class="sil-btn" onclick="sepettenSil(${i})">‚úï</button></td>
                    </tr>
                `;
            }).join('');
            
            hesaplaToplamlar();
        }
        
        function hesaplaToplamlar() {
            const kdvOrani = parseInt(document.getElementById('kdvOrani').value);
            const araToplam = sepet.reduce((sum, item) => sum + (item.miktar * item.birimFiyat), 0);
            const kdvTutar = araToplam * (kdvOrani / 100);
            const genelToplam = araToplam + kdvTutar;
            
            document.getElementById('araToplam').textContent = formatPara(araToplam);
            document.getElementById('kdvOranText').textContent = kdvOrani;
            document.getElementById('kdvTutar').textContent = formatPara(kdvTutar);
            document.getElementById('genelToplam').textContent = formatPara(genelToplam);
        }
        
        function sepetiTemizle() {
            if (sepet.length === 0) return;
            if (confirm('T√ºm se√ßimleri silmek istediƒüinize emin misiniz?')) {
                sepet = [];
                renderSepet();
            }
        }
        
        async function teklifKaydet() {
            const musteriId = document.getElementById('musteriSelect').value;
            if (!musteriId) {
                showToast('L√ºtfen m√º≈üteri se√ßin', 'error');
                return;
            }
            if (sepet.length === 0) {
                showToast('L√ºtfen en az bir hizmet ekleyin', 'error');
                return;
            }

            const data = {
                customerId: parseInt(musteriId),
                gecerlilikGunu: 30,
                kdvOrani: parseInt(document.getElementById('kdvOrani').value),
                onayTelefon: document.getElementById('onayTelefon').checked,
                sahadaOnay: document.getElementById('sahadaOnay').checked,
                notlar: '',
                detaylar: sepet.map(s => ({
                    hizmetId: s.hizmetId,
                    miktar: s.miktar,
                    birimFiyat: s.birimFiyat
                }))
            };

            try {
                let res;
                if (editingTeklifId) {
                    // D√ºzenleme modu - PUT
                    res = await fetch(API_BASE + '/api/teklifler/' + editingTeklifId, {
                        method: 'PUT',
                        headers: getHeaders(),
                        body: JSON.stringify(data)
                    });
                } else {
                    // Yeni teklif - POST
                    res = await fetch(API_BASE + '/api/teklifler', {
                        method: 'POST',
                        headers: getHeaders(),
                        body: JSON.stringify(data)
                    });
                }

                const result = await res.json();

                if (res.ok) {
                    const mesaj = editingTeklifId ? 'Teklif g√ºncellendi: ' : 'Teklif olu≈üturuldu: ';
                    showToast(mesaj + result.teklifNo, 'success');
                    setTimeout(() => {
                        window.location.href = '/index.html';
                    }, 1500);
                } else {
                    showToast(result.error || 'ƒ∞≈ülem ba≈üarƒ±sƒ±z', 'error');
                }
            } catch (e) {
                console.error('Kaydetme hatasƒ±:', e);
                showToast('Bir hata olu≈ütu', 'error');
            }
        }
        
        function formatPara(num) {
            return parseFloat(num).toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' ‚Ç∫';
        }
        
        function showToast(msg, type) {
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
