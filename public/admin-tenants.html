<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firma Y√∂netimi - S√ºper Admin</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Toast Bildirimleri -->
    <div id="toast-container"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p>Y√ºkleniyor...</p>
    </div>

    <!-- Ana Container -->
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="/images/logo.png" alt="√ñNDER MUAYENE" style="max-width: 180px; margin-bottom: 10px;">
                <p>Periyodik Muayene Y√∂netim</p>
            </div>
            <nav class="sidebar-nav">
                <a href="index.html" class="nav-item">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="#" class="nav-item active">
                    <span class="nav-icon">üè¢</span>
                    <span class="nav-text">Firma Y√∂netimi</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <button class="btn btn-danger btn-block" onclick="sistemdenCik()">
                    <span class="nav-icon">üö™</span> √áƒ±kƒ±≈ü
                </button>
                <p>v1.0.0</p>
                <p>¬© 2025 √ñNDER MUAYENE</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-content active">
                <div class="page-header">
                    <div>
                        <h2>üè¢ Firma Y√∂netimi</h2>
                        <p>Sistemdeki firmalarƒ± y√∂net</p>
                    </div>
                    <div class="page-actions">
                        <button class="btn btn-primary" onclick="yeniFirmaModal()">‚ûï Yeni Firma</button>
                    </div>
                </div>

                <!-- Arama ve Filtre -->
                <div class="search-bar">
                    <input type="text" id="firma-arama" placeholder="Firma ara (isim, alan adƒ±)..." onkeyup="firmaAra()">
                </div>

                <!-- Firma Listesi -->
                <div class="table-container">
                    <table id="firma-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Firma Adƒ±</th>
                                <th>Alan Adƒ±</th>
                                <th>Logo</th>
                                <th>Kullanƒ±cƒ± Sayƒ±sƒ±</th>
                                <th>Durum</th>
                                <th>Olu≈üturma Tarihi</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" class="text-center">Y√ºkleniyor...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Firma Modal -->
    <div id="firma-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="firma-modal-baslik">Yeni Firma Ekle</h3>
                <span class="close" onclick="closeFirmaModal()">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="firma-id">
                <div class="form-group">
                    <label>Firma Adƒ±: *</label>
                    <input type="text" id="firma-name" class="form-input" placeholder="√ñrn: ABC ≈ûirketi" required>
                </div>
                <div class="form-group">
                    <label>Alan Adƒ± (Subdomain): *</label>
                    <input type="text" id="firma-subdomain" class="form-input" placeholder="√ñrn: abc" required>
                    <small class="text-muted">Not: abc.muayene.kgmdijital.com ≈üeklinde kullanƒ±lacak</small>
                </div>
                <div class="form-group">
                    <label>Logo URL:</label>
                    <input type="text" id="firma-logo" class="form-input" placeholder="√ñrn: /images/abc-logo.png">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="firma-active" checked> Aktif
                    </label>
                </div>
                <button class="btn btn-primary" onclick="firmaKaydet()">üíæ Kaydet</button>
                <button class="btn btn-secondary" onclick="closeFirmaModal()">ƒ∞ptal</button>
            </div>
        </div>
    </div>

    <!-- Kullanƒ±cƒ± Ekle Modal -->
    <div id="kullanici-ekle-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Firmaya Kullanƒ±cƒ± Ekle</h3>
                <span class="close" onclick="closeKullaniciEkleModal()">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="kullanici-tenant-id">
                <p><strong>Firma:</strong> <span id="kullanici-firma-adi"></span></p>
                <div class="form-group">
                    <label>Ad Soyad: *</label>
                    <input type="text" id="kullanici-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>E-posta: *</label>
                    <input type="email" id="kullanici-email" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>≈ûifre: *</label>
                    <input type="password" id="kullanici-password" class="form-input" required>
                    <small class="text-muted">En az 6 karakter</small>
                </div>
                <div class="form-group">
                    <label>Rol: *</label>
                    <select id="kullanici-role" class="form-input" required>
                        <option value="user">Kullanƒ±cƒ±</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="kullaniciKaydet()">üíæ Kaydet</button>
                <button class="btn btn-secondary" onclick="closeKullaniciEkleModal()">ƒ∞ptal</button>
            </div>
        </div>
    </div>

    <script>
        // Toast fonksiyonlarƒ±
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.getElementById('toast-container').appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Loading fonksiyonlarƒ±
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // Session kontrol√º
        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    localStorage.removeItem('token');
                    window.location.href = '/login';
                    return;
                }

                const data = await response.json();
                if (data.user.role !== 'superadmin') {
                    showToast('Bu sayfaya eri≈üim yetkiniz yok!', 'error');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                }
            } catch (error) {
                console.error('Auth kontrol hatasƒ±:', error);
                window.location.href = '/login';
            }
        }

        // √áƒ±kƒ±≈ü fonksiyonu
        async function sistemdenCik() {
            const token = localStorage.getItem('token');
            if (token) {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
            }
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        // Firma listesini y√ºkle
        async function loadFirmalar() {
            showLoading();
            try {
                const response = await fetch('/api/admin/tenants', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Firmalar y√ºklenemedi');

                const firmalar = await response.json();
                displayFirmalar(firmalar);
            } catch (error) {
                console.error('Firma y√ºkleme hatasƒ±:', error);
                showToast('Firmalar y√ºklenemedi!', 'error');
            } finally {
                hideLoading();
            }
        }

        // Firmalarƒ± g√∂ster
        function displayFirmalar(firmalar) {
            const tbody = document.querySelector('#firma-table tbody');
            
            if (firmalar.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">Hen√ºz firma bulunmuyor</td></tr>';
                return;
            }

            tbody.innerHTML = firmalar.map(firma => `
                <tr>
                    <td>${firma.id}</td>
                    <td>${firma.name}</td>
                    <td>${firma.subdomain}</td>
                    <td>${firma.logo ? `<img src="${firma.logo}" alt="Logo" style="height: 30px;">` : '-'}</td>
                    <td>${firma._count?.users || 0}</td>
                    <td>
                        <span class="badge ${firma.active ? 'badge-success' : 'badge-danger'}">
                            ${firma.active ? 'Aktif' : 'Pasif'}
                        </span>
                    </td>
                    <td>${new Date(firma.createdAt).toLocaleDateString('tr-TR')}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="firmaKullanicilari(${firma.id}, '${firma.name}')">
                            üë• Kullanƒ±cƒ±lar
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="firmaDuzenle(${firma.id})">
                            ‚úèÔ∏è D√ºzenle
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="firmaSil(${firma.id})">
                            üóëÔ∏è Sil
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Firma arama
        function firmaAra() {
            const searchTerm = document.getElementById('firma-arama').value.toLowerCase();
            const rows = document.querySelectorAll('#firma-table tbody tr');
            
            rows.forEach(row => {
                const name = row.cells[1]?.textContent.toLowerCase() || '';
                const subdomain = row.cells[2]?.textContent.toLowerCase() || '';
                
                if (name.includes(searchTerm) || subdomain.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Firma modal fonksiyonlarƒ±
        function yeniFirmaModal() {
            document.getElementById('firma-modal-baslik').textContent = 'Yeni Firma Ekle';
            document.getElementById('firma-id').value = '';
            document.getElementById('firma-name').value = '';
            document.getElementById('firma-subdomain').value = '';
            document.getElementById('firma-logo').value = '';
            document.getElementById('firma-active').checked = true;
            document.getElementById('firma-modal').style.display = 'block';
        }

        function closeFirmaModal() {
            document.getElementById('firma-modal').style.display = 'none';
        }

        async function firmaKaydet() {
            const id = document.getElementById('firma-id').value;
            const data = {
                name: document.getElementById('firma-name').value.trim(),
                subdomain: document.getElementById('firma-subdomain').value.trim(),
                logo: document.getElementById('firma-logo').value.trim() || null,
                active: document.getElementById('firma-active').checked
            };

            if (!data.name || !data.subdomain) {
                showToast('Firma adƒ± ve alan adƒ± zorunludur!', 'error');
                return;
            }

            showLoading();
            try {
                const url = id ? `/api/admin/tenants/${id}` : '/api/admin/tenants';
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Firma kaydedilemedi');
                }

                showToast(id ? 'Firma g√ºncellendi!' : 'Firma eklendi!', 'success');
                closeFirmaModal();
                loadFirmalar();
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function firmaDuzenle(id) {
            showLoading();
            try {
                const response = await fetch(`/api/admin/tenants/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Firma bilgileri y√ºklenemedi');

                const firma = await response.json();
                
                document.getElementById('firma-modal-baslik').textContent = 'Firma D√ºzenle';
                document.getElementById('firma-id').value = firma.id;
                document.getElementById('firma-name').value = firma.name;
                document.getElementById('firma-subdomain').value = firma.subdomain;
                document.getElementById('firma-logo').value = firma.logo || '';
                document.getElementById('firma-active').checked = firma.active;
                document.getElementById('firma-modal').style.display = 'block';
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function firmaSil(id) {
            if (!confirm('Bu firmayƒ± silmek istediƒüinizden emin misiniz?')) return;

            showLoading();
            try {
                const response = await fetch(`/api/admin/tenants/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Firma silinemedi');
                }

                showToast('Firma silindi!', 'success');
                loadFirmalar();
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Kullanƒ±cƒ± ekleme fonksiyonlarƒ±
        function firmaKullanicilari(tenantId, tenantName) {
            document.getElementById('kullanici-tenant-id').value = tenantId;
            document.getElementById('kullanici-firma-adi').textContent = tenantName;
            document.getElementById('kullanici-name').value = '';
            document.getElementById('kullanici-email').value = '';
            document.getElementById('kullanici-password').value = '';
            document.getElementById('kullanici-role').value = 'user';
            document.getElementById('kullanici-ekle-modal').style.display = 'block';
        }

        function closeKullaniciEkleModal() {
            document.getElementById('kullanici-ekle-modal').style.display = 'none';
        }

        async function kullaniciKaydet() {
            const data = {
                tenantId: parseInt(document.getElementById('kullanici-tenant-id').value),
                name: document.getElementById('kullanici-name').value.trim(),
                email: document.getElementById('kullanici-email').value.trim(),
                password: document.getElementById('kullanici-password').value,
                role: document.getElementById('kullanici-role').value
            };

            if (!data.name || !data.email || !data.password) {
                showToast('T√ºm alanlarƒ± doldurun!', 'error');
                return;
            }

            if (data.password.length < 6) {
                showToast('≈ûifre en az 6 karakter olmalƒ±dƒ±r!', 'error');
                return;
            }

            showLoading();
            try {
                const response = await fetch(`/api/admin/tenants/${data.tenantId}/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Kullanƒ±cƒ± eklenemedi');
                }

                showToast('Kullanƒ±cƒ± eklendi!', 'success');
                closeKullaniciEkleModal();
                loadFirmalar();
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Modal dƒ±≈üƒ±na tƒ±klandƒ±ƒüƒ±nda kapat
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        }

        // Sayfa y√ºklendiƒüinde
        window.onload = async function() {
            await checkAuth();
            await loadFirmalar();
        };
    </script>
</body>
</html>